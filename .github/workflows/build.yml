name: Build 386BSD

on:
  push:
    branches: [ main, '2.0', 'copilot/**' ]
  pull_request:
    branches: [ main, '2.0' ]

jobs:
  build-legacy:
    name: "Legacy 386BSD Build System (BMake)"
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install legacy dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bmake \
          flex \
          bison \
          git

    - name: Test BMake availability
      run: |
        which bmake
        bmake -V _BMAKE_VERSION || echo "BMake version check failed"

    - name: Attempt legacy userland build
      continue-on-error: true
      run: |
        cd usr/src
        timeout 300 bmake clean || echo "Clean completed or timed out"
        timeout 600 bmake depend || echo "Depend step completed or failed"
        timeout 900 bmake all > ../build_userland.log 2>&1 || echo "Build attempted"

    - name: Attempt legacy kernel build
      continue-on-error: true
      run: |
        cd usr/src/kernel
        timeout 300 bmake clean || echo "Kernel clean completed or timed out"
        timeout 600 bmake depend || echo "Kernel depend step completed or failed"
        timeout 900 bmake all > ../../build_kernel.log 2>&1 || echo "Kernel build attempted"

    - name: Archive legacy build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: legacy-build-logs
        path: |
          usr/build_userland.log
          usr/build_kernel.log

  troubleshooting:
    name: "Build Troubleshooting"
    runs-on: ubuntu-24.04
    if: failure()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System diagnostics
      run: |
        echo "=== System Information ==="
        uname -a
        lsb_release -a
        echo "=== Available packages ==="
        apt list --installed | grep -E "(make|cmake|doxygen|sphinx|flex|bison)" || true
        echo "=== Build tool versions ==="
        make --version || echo "make not found"
        bmake -V _BMAKE_VERSION || echo "bmake not found"
        echo "=== File system check ==="
        ls -la usr/src/
        ls -la usr/src/kernel/ | head -5
        echo "=== Kernel config check ==="
        ls -la usr/src/kernel/config/

    - name: Upload diagnostic logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: troubleshooting-info
        path: |
          /var/log/apt/
          /tmp/build-debug.log